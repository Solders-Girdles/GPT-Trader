<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Trading Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .positive {
            color: #4ade80;
        }
        
        .negative {
            color: #f87171;
        }
        
        .neutral {
            color: #fbbf24;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }
        
        .buy {
            color: #4ade80;
        }
        
        .sell {
            color: #f87171;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        select, input[type="number"], input[type="checkbox"] {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.08);
            color: #fff;
        }
        label { opacity: 0.8; font-size: 0.9em; }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }
        
        .status-active {
            background: #4ade80;
        }
        
        .status-inactive {
            background: #f87171;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .chart-container {
            height: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            position: relative;
        }
        
        #equityChart {
            width: 100%;
            height: 100%;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            opacity: 0.5;
            font-size: 1.2em;
        }
        
        .refresh-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        /* Status badges */
        .status-badge { padding: 2px 8px; border-radius: 999px; font-size: 0.85em; }
        .status-running { background: rgba(34,197,94,0.2); border:1px solid rgba(34,197,94,0.4); color:#bbf7d0; }
        .status-stopped { background: rgba(148,163,184,0.2); border:1px solid rgba(148,163,184,0.4); color:#e2e8f0; }
        .status-error { background: rgba(239,68,68,0.2); border:1px solid rgba(239,68,68,0.4); color:#fecaca; }
        .status-paused { background: rgba(250,204,21,0.2); border:1px solid rgba(250,204,21,0.4); color:#fef08a; }
        /* Toasts */
        .toast-container { position: fixed; top:16px; right:16px; z-index:2000; display:flex; flex-direction:column; gap:10px; }
        .toast { padding:10px 14px; border-radius:8px; color:#fff; min-width:220px; box-shadow:0 4px 12px rgba(0,0,0,0.25); opacity:0.95; }
        .toast-success { background:#16a34a; }
        .toast-error { background:#dc2626; }
        .toast-info { background:#2563eb; }
        /* Modal */
        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000; }
        .modal { width: 800px; max-width:95vw; background: rgba(20,30,60,0.98); border:1px solid rgba(255,255,255,0.15); border-radius:12px; padding:20px; }
        .modal h3 { margin-bottom: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; }
        .modal .row { margin: 8px 0; }
        .modal input, .modal textarea, .modal select { width: 100%; }
        .modal textarea { min-height: 100px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="toasts" class="toast-container"></div>
        <h1>ðŸ“Š Paper Trading Dashboard</h1>
        
        <div class="status-bar">
            <div>
                <span class="status-indicator status-inactive" id="statusIndicator"></span>
                <span id="statusText">Waiting for data...</span>
            </div>
            <div class="controls">
                <label>Session:</label>
                <select id="sessionSelect"></select>
                <label>Auto-refresh</label>
                <input type="checkbox" id="autoRefresh" checked>
                <label>Interval (s)</label>
                <input type="number" id="refreshInterval" value="3" min="1" max="60" style="width:60px;">
                <span id="lastUpdate">Never</span>
                <button class="refresh-btn" onclick="loadData()">Refresh</button>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="section" id="tabs" style="margin-top:10px;">
            <div class="controls" style="gap:14px;">
                <button class="refresh-btn" id="tab-overview">Overview</button>
                <button class="refresh-btn" id="tab-bots">Bots</button>
                <button class="refresh-btn" id="tab-sessions">Sessions</button>
            </div>
        </div>

        <div id="overview-top">
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Equity</div>
                <div class="metric-value" id="equity">$0.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Return</div>
                <div class="metric-value" id="totalReturn">0.00%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Win Rate</div>
                <div class="metric-value" id="winRate">0.0%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Trades</div>
                <div class="metric-value" id="numTrades">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Positions</div>
                <div class="metric-value" id="numPositions">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Drawdown</div>
                <div class="metric-value" id="drawdown">0.00%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Trades / hr</div>
                <div class="metric-value" id="tradesPerHour">0.0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Signals / hr</div>
                <div class="metric-value" id="signalsPerHour">0.0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Exec Rate</div>
                <div class="metric-value" id="execRate">0.0%</div>
            </div>
        </div>
        </div>
        
        <div id="section-sessions">
        <div class="section">
            <h2 class="section-title">Equity Chart</h2>
            <div class="chart-container">
                <canvas id="equityChart"></canvas>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Session Info</h2>
            <div id="sessionInfo" class="no-data">No session loaded</div>
        </div>
        </div>

        <div id="section-bots">
        <div class="section">
            <h2 class="section-title">Bots</h2>
            <div class="controls" style="margin-bottom:10px;">
                <button class="refresh-btn" onclick="loadBots()">Refresh Bots</button>
            </div>
            <div id="botsTable"><div class="no-data">No bots</div></div>
            <div class="section" style="margin-top:16px;">
                <h3 class="section-title">Bot Events</h3>
                <div class="controls">
                    <input id="eventsBotId" placeholder="bot id" style="width:160px;">
                    <input id="eventsLimit" type="number" value="50" min="10" max="500" style="width:80px;">
                    <select id="eventsTypes"><option value="">all</option><option value="metric">metric</option><option value="trade">trade</option><option value="error">error</option></select>
                    <button class="refresh-btn" onclick="loadBotEvents()">Load</button>
                    <button class="refresh-btn" onclick="moreEvents()">Load More</button>
                </div>
                <div id="botEvents"><div class="no-data">No events loaded</div></div>
            </div>
            <div style="margin-top:16px;">
                <h3 class="section-title">Create Bot</h3>
                <div class="controls" style="flex-wrap: wrap; gap:8px;">
                    <input id="botId" placeholder="id">
                    <input id="botName" placeholder="name">
                    <select id="botStrategy">
                        <option value="scalp">scalp</option>
                        <option value="momentum">momentum</option>
                        <option value="mean_reversion">mean_reversion</option>
                        <option value="breakout">breakout</option>
                        <option value="ma_crossover">ma_crossover</option>
                        <option value="volatility">volatility</option>
                    </select>
                    <input id="botSymbols" placeholder="symbols (comma)">
                    <input id="botCapital" type="number" value="10000" step="100" placeholder="capital">
                    <input id="botMaxPos" type="number" value="6" placeholder="max positions">
                    <input id="botMaxSize" type="number" value="0.2" step="0.01" placeholder="max size">
                    <input id="botSL" type="number" value="0.04" step="0.005" placeholder="stop loss">
                    <input id="botTP" type="number" value="0.08" step="0.005" placeholder="take profit">
                    <input id="botFee" type="number" value="0.004" step="0.001" placeholder="fee">
                    <input id="botSlip" type="number" value="0.001" step="0.0005" placeholder="slippage">
                    <input id="botLoop" type="number" value="5" step="0.5" placeholder="loop(s)">
                    <label><input type="checkbox" id="botAuto" checked> Auto-start</label>
                    <button class="refresh-btn" onclick="createBot()">Create</button>
                </div>
            </div>
        </div>
        </div>
        
        <div id="overview-bottom">
        <div class="section">
            <h2 class="section-title">Open Positions</h2>
            <div id="positionsTable">
                <div class="no-data">No open positions</div>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">Recent Trades</h2>
            <div id="tradesTable">
                <div class="no-data">No trades yet</div>
            </div>
        </div>
        </div>
        
        <!-- Edit Modal -->
        <div id="editOverlay" class="modal-overlay">
          <div class="modal">
            <h3>Edit Bot</h3>
            <div class="section" style="padding:10px; margin-bottom:12px;">
              <div style="display:flex; gap:10px; align-items:center;">
                <div style="flex:1; min-height:120px;">
                  <canvas id="edEquityChart" height="120"></canvas>
                </div>
                <div style="min-width:220px;">
                  <div class="metric-card" style="padding:10px; margin-bottom:8px;">
                    <div class="metric-label">Recent Exec Rate</div>
                    <div class="metric-value" id="edExec">0.0%</div>
                  </div>
                  <div class="metric-card" style="padding:10px;">
                    <div class="metric-label">Recent Trades/hr</div>
                    <div class="metric-value" id="edTph">0.0</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="grid-2">
              <div class="row"><label>Name</label><input id="edName"></div>
              <div class="row"><label>Loop Sleep (s)</label><input id="edLoop" type="number" step="0.5"></div>
              <div class="row"><label>Auto-start</label><input id="edAuto" type="checkbox"></div>
            </div>
            <h4 style="margin-top:12px;">Risk</h4>
            <div style="opacity:0.8; font-size:0.9em; margin-bottom:6px;">Typical ranges: size 0.05â€“0.3, SL 0.02â€“0.10, TP 0.04â€“0.20, fee < 0.01, slippage < 0.01.</div>
            <div class="grid-2">
              <div class="row"><label>Max Positions</label><input id="edMaxPos" type="number"></div>
              <div class="row"><label>Max Size (fraction)</label><input id="edMaxSize" type="number" step="0.01"></div>
              <div class="row"><label>Stop Loss (fraction)</label><input id="edSL" type="number" step="0.005"></div>
              <div class="row"><label>Take Profit (fraction)</label><input id="edTP" type="number" step="0.005"></div>
              <div class="row"><label>Commission (fraction)</label><input id="edFee" type="number" step="0.001"></div>
              <div class="row"><label>Slippage (fraction)</label><input id="edSlip" type="number" step="0.0005"></div>
            </div>
            <h4 style="margin-top:12px;">Strategy Params (key=value per line)</h4>
            <textarea id="edParams" placeholder="threshold=0.01
fast_period=10
..."></textarea>
            <div id="edError" class="no-data" style="display:none; margin:8px 0; padding:8px; border-radius:6px; background: rgba(255,0,0,0.15); border:1px solid rgba(255,0,0,0.3);">Validation errors</div>
            <div class="grid-2" style="margin-top:12px;">
              <div class="row"><label>Duplicate as (new id)</label><input id="dupId" placeholder="bot_copy"></div>
              <div class="row" style="display:flex; gap:10px; align-items:center; justify-content:flex-end;">
                <button class="refresh-btn" onclick="closeEdit()">Cancel</button>
                <button class="refresh-btn" onclick="saveEdit()">Save</button>
                <button class="refresh-btn" onclick="duplicateBot()">Duplicate</button>
              </div>
            </div>
          </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chart = null;
        let edChart = null;
        let updateInterval = null;
        let selectedFile = null;
        let botsInterval = null;
        let activeTab = localStorage.getItem('activeTab') || 'overview';
        
        // Initialize chart
        const ctx = document.getElementById('equityChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Equity',
                    data: [],
                    borderColor: '#4ade80',
                    backgroundColor: 'rgba(74, 222, 128, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            callback: function(value) {
                                return '$' + value.toFixed(0);
                            }
                        }
                    }
                }
            }
        });
        
        async function fetchSessions() {
            try {
                const resp = await fetch('/api/sessions');
                const data = await resp.json();
                const sel = document.getElementById('sessionSelect');
                sel.innerHTML = '';
                const sessions = (data.sessions || []);
                const saved = localStorage.getItem('sessionFile') || '';
                for (const s of sessions) {
                    const opt = document.createElement('option');
                    opt.value = s.name;
                    opt.textContent = s.name;
                    sel.appendChild(opt);
                }
                if (saved && sessions.some(x=>x.name===saved)) { selectedFile = saved; sel.value = saved; }
                else if (!selectedFile && sessions.length > 0) { selectedFile = sessions[0].name; sel.value = selectedFile; }
            } catch (e) {
                console.error('Failed to load sessions', e);
            }
        }

        async function loadData() {
            try {
                const q = selectedFile ? ('?file=' + encodeURIComponent(selectedFile)) : '';
                const response = await fetch('/api/session' + q);
                const data = await response.json();
                
                if (data && data.metrics) {
                    updateDashboard(data);
                    
                    // Update status
                    document.getElementById('statusIndicator').className = 'status-indicator status-active';
                    document.getElementById('statusText').textContent = `Active: ${data.strategy || data.metrics.strategy || 'Unknown'} Strategy`;
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        async function loadBots() {
            try {
                const resp = await fetch('/api/bots');
                const data = await resp.json();
                renderBots(data.bots || []);
            } catch (e) {
                console.error('Bots load failed', e);
            }
        }

        function renderBots(bots) {
            const container = document.getElementById('botsTable');
            if (!bots.length) { container.innerHTML = '<div class="no-data">No bots</div>'; return; }
            let html = `
            <table>
                <thead>
                    <tr>
                        <th>ID</th><th>Name</th><th>Status</th><th>Auto</th><th>Loop(s)</th><th>Strategy</th><th>Symbols</th>
                        <th>Trades/hr</th><th>Signals/hr</th><th>Exec%</th><th>Actions</th>
                    </tr>
                </thead>
                <tbody>
            `;
            for (const b of bots) {
                html += `
                    <tr>
                        <td>${b.id}</td>
                        <td>${b.name}</td>
                        <td>${formatStatus(b.status)}</td>
                        <td>${b.auto_start ? 'âœ”' : 'â€”'}</td>
                        <td><input id="loop_${b.id}" type="number" step="0.5" value="${(b.config.loop_sleep || 5).toFixed(1)}" style="width:70px;"></td>
                        <td>${b.config.strategy}</td>
                        <td>${(b.config.symbols || []).join(', ')}</td>
                        <td>${(b.metrics.trades_per_hour || 0).toFixed(1)}</td>
                        <td>${(b.metrics.signals_per_hour || 0).toFixed(1)}</td>
                        <td>${(b.metrics.execution_rate || 0).toFixed(1)}%</td>
                        <td>
                            <label style="margin-right:8px;">
                                <input type="checkbox" id="auto_${b.id}" ${b.auto_start ? 'checked' : ''}> auto
                            </label>
                            <button class="refresh-btn" onclick="applyQuickUpdate('${b.id}')">Apply</button>
                            <button class="refresh-btn" onclick="openEdit('${b.id}')">Edit</button>
                            <button class="refresh-btn" onclick="botAction('${b.id}','start')">Start</button>
                            <button class="refresh-btn" onclick="botAction('${b.id}','stop')">Stop</button>
                            <button class="refresh-btn" onclick="botAction('${b.id}','snapshot')">Snapshot</button>
                            <button class="refresh-btn" onclick="deleteBot('${b.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function botAction(id, action) {
            try {
                const resp = await fetch(`/api/bots/${id}/${action}`, { method: 'POST' });
                const data = await resp.json().catch(()=>({}));
                if (!resp.ok || data.status === 'error') { showToast((data.errors||[]).join(' | ') || 'Action failed', 'error'); }
                else { showToast(`${action} OK for ${id}`, 'success'); }
                loadBots();
                if (action === 'snapshot') {
                    const ev = document.getElementById('eventsBotId');
                    if (ev) ev.value = id;
                    if (typeof loadBotEvents === 'function') loadBotEvents();
                }
            } catch (e) { console.error('bot action failed', e); showToast('Action error', 'error'); }
        }

        function formatStatus(s) {
            const st = (s||'').toLowerCase();
            if (st === 'running') return `<span class="status-badge status-running">Running</span>`;
            if (st === 'error') return `<span class="status-badge status-error">Error</span>`;
            if (st === 'paused') return `<span class="status-badge status-paused">Paused</span>`;
            return `<span class="status-badge status-stopped">Stopped</span>`;
        }

        async function deleteBot(id) {
            if (!confirm(`Delete bot ${id}? This will remove it from persistence.`)) return;
            try {
                const resp = await fetch(`/api/bots/${id}`, { method:'DELETE' });
                const res = await resp.json().catch(()=>({}));
                if (!resp.ok || res.status === 'error') { showToast((res.errors||[]).join(' | ') || 'Delete failed', 'error'); }
                else { showToast('Bot deleted', 'success'); loadBots(); }
            } catch (e) { console.error('delete failed', e); showToast('Delete error', 'error'); }
        }

        async function createBot() {
            const err = [];
            const payload = {
                id: document.getElementById('botId').value,
                name: document.getElementById('botName').value,
                strategy: document.getElementById('botStrategy').value,
                symbols: document.getElementById('botSymbols').value,
                capital: parseFloat(document.getElementById('botCapital').value || '10000'),
                loop_sleep: parseFloat(document.getElementById('botLoop').value || '5'),
                auto_start: document.getElementById('botAuto').checked,
                risk: {
                    max_positions: parseInt(document.getElementById('botMaxPos').value || '6'),
                    max_position_size: parseFloat(document.getElementById('botMaxSize').value || '0.2'),
                    stop_loss: parseFloat(document.getElementById('botSL').value || '0.04'),
                    take_profit: parseFloat(document.getElementById('botTP').value || '0.08'),
                    commission: parseFloat(document.getElementById('botFee').value || '0.004'),
                    slippage: parseFloat(document.getElementById('botSlip').value || '0.001'),
                }
            };
            // client validation
            const errs = [];
            if (payload.loop_sleep <= 0 || payload.loop_sleep > 120) errs.push('Loop sleep must be 0-120s');
            if (!(payload.risk.max_position_size > 0 && payload.risk.max_position_size <= 1)) errs.push('Max size must be in (0,1]');
            ['stop_loss','take_profit','commission','slippage'].forEach(k=>{ const v = payload.risk[k]; if (!(v >= 0 && v < 1)) errs.push(`risk.${k} must be in [0,1)`); });
            if (errs.length){ alert('Validation: ' + errs.join(' | ')); return; }
            try {
                const resp = await fetch('/api/bots', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                const res = await resp.json().catch(()=>({}));
                if (!resp.ok || res.status === 'error') { showToast((res.errors||[]).join(' | ') || 'Create failed', 'error'); }
                else { showToast('Bot created', 'success'); loadBots(); }
            } catch (e) { console.error('create failed', e); }
        }

        async function applyQuickUpdate(id) {
            const auto = document.getElementById(`auto_${id}`).checked;
            const loop = parseFloat(document.getElementById(`loop_${id}`).value || '5');
            try {
                const resp = await fetch(`/api/bots/${id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ auto_start: auto, loop_sleep: loop })});
                const res = await resp.json().catch(()=>({}));
                if (!resp.ok || res.status === 'error') { showToast((res.errors||[]).join(' | ') || 'Update failed', 'error'); }
                else { showToast('Updated', 'success'); loadBots(); }
            } catch (e) { console.error('update failed', e); showToast('Update error', 'error'); }
        }
        
        
        // Edit modal
        let currentEditId = null;
        function closeEdit() { document.getElementById('editOverlay').style.display = 'none'; currentEditId = null; }
        async function openEdit(id) {
            try {
                const resp = await fetch(`/api/bots/${id}`);
                const b = await resp.json();
                currentEditId = id;
                document.getElementById('edName').value = b.name || '';
                document.getElementById('edLoop').value = b.config.loop_sleep || 5;
                document.getElementById('edAuto').checked = !!b.auto_start;
                const r = b.config.risk || {};
                document.getElementById('edMaxPos').value = r.max_positions || 6;
                document.getElementById('edMaxSize').value = r.max_position_size || 0.2;
                document.getElementById('edSL').value = r.stop_loss || 0.04;
                document.getElementById('edTP').value = r.take_profit || 0.08;
                document.getElementById('edFee').value = r.commission || 0.004;
                document.getElementById('edSlip').value = r.slippage || 0.001;
                const sp = b.config.strategy_params || {};
                const lines = Object.keys(sp).map(k => `${k}=${sp[k]}`);
                document.getElementById('edParams').value = lines.join('
');
                document.getElementById('dupId').value = `${id}_copy`;
                await loadEditMetrics(id);
                document.getElementById('editOverlay').style.display = 'flex';
            } catch (e) { console.error('open edit failed', e); }
        }

        async function loadEditMetrics(id) {
            try {
                const resp = await fetch(`/api/bots/${id}/events?types=metric&limit=200`);
                const data = await resp.json();
                const evts = data.events || [];
                const labels = evts.map(e => new Date(e.time).toLocaleTimeString());
                const values = evts.map(e => Number(e.equity || 0));
                const latest = evts.length ? evts[evts.length-1] : {};
                const exec = Number(latest.execution_rate || 0);
                const tph = Number(latest.trades_per_hour || 0);
                const execEl = document.getElementById('edExec');
                const tphEl = document.getElementById('edTph');
                if (execEl) execEl.textContent = `${exec.toFixed(1)}%`;
                if (tphEl) tphEl.textContent = `${tph.toFixed(1)}`;
                const cnv = document.getElementById('edEquityChart');
                if (cnv) {
                    const ctx2 = cnv.getContext('2d');
                    if (edChart) { try { edChart.destroy(); } catch(_){} }
                    edChart = new Chart(ctx2, {
                        type: 'line',
                        data: { labels, datasets: [{ label:'Equity', data: values, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.15)', fill:true, tension:0.3 }] },
                        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'rgba(255,255,255,0.7)' }, grid:{ color:'rgba(255,255,255,0.1)' } }, y:{ ticks:{ color:'rgba(255,255,255,0.7)' }, grid:{ color:'rgba(255,255,255,0.1)' } } } }
                    });
                }
            } catch (e) {
                console.error('loadEditMetrics failed', e);
            }
        }

        function parseParamsKV(text) {
            const out = {};
            (text || '').split('
').forEach(line => {
                const l = line.trim();
                if (!l || l.startsWith('#') || !l.includes('=')) return;
                const [k, vraw] = l.split('=', 2);
                const k2 = k.trim();
                const vr = (vraw || '').trim();
                const vl = vr.toLowerCase();
                if (vl === 'true' || vl === 'false') { out[k2] = (vl === 'true'); return; }
                if (!isNaN(Number(vr))) { out[k2] = Number(vr); return; }
                out[k2] = vr;
            });
            return out;
        }

        async function saveEdit() {
            const errBox = document.getElementById('edError');
            errBox.style.display = 'none';
            errBox.textContent = '';
            if (!currentEditId) return;
            const payload = {
                name: document.getElementById('edName').value,
                loop_sleep: parseFloat(document.getElementById('edLoop').value || '5'),
                auto_start: document.getElementById('edAuto').checked,
                risk: {
                    max_positions: parseInt(document.getElementById('edMaxPos').value || '6'),
                    max_position_size: parseFloat(document.getElementById('edMaxSize').value || '0.2'),
                    stop_loss: parseFloat(document.getElementById('edSL').value || '0.04'),
                    take_profit: parseFloat(document.getElementById('edTP').value || '0.08'),
                    commission: parseFloat(document.getElementById('edFee').value || '0.004'),
                    slippage: parseFloat(document.getElementById('edSlip').value || '0.001'),
                },
                strategy_params: parseParamsKV(document.getElementById('edParams').value)
            };
            // client validation
            const errs = [];
            if (payload.loop_sleep <= 0 || payload.loop_sleep > 120) errs.push('Loop sleep must be 0-120s');
            if (!(payload.risk.max_position_size > 0 && payload.risk.max_position_size <= 1)) errs.push('Max size must be in (0,1]');
            ['stop_loss','take_profit','commission','slippage'].forEach(k=>{ const v = payload.risk[k]; if (!(v >= 0 && v < 1)) errs.push(`risk.${k} must be in [0,1)`); });
            if (errs.length){ alert('Validation: ' + errs.join(' | ')); return; }
            try {
                await fetch(`/api/bots/${currentEditId}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                closeEdit();
                loadBots();
            } catch (e) { console.error('save edit failed', e); }
        }

        async function duplicateBot() {
            if (!currentEditId) return;
            const newId = document.getElementById('dupId').value.trim();
            if (!newId) return;
            let strategy = 'scalp'; let symbols = [];
            try {
                const resp = await fetch(`/api/bots/${currentEditId}`);
                const b = await resp.json();
                strategy = b.config.strategy || 'scalp';
                symbols = b.config.symbols || [];
            } catch (e) {}
            const payload = {
                id: newId,
                name: document.getElementById('edName').value || newId,
                strategy,
                symbols: symbols.join(','),
                capital: 10000,
                loop_sleep: parseFloat(document.getElementById('edLoop').value || '5'),
                auto_start: false,
                risk: {
                    max_positions: parseInt(document.getElementById('edMaxPos').value || '6'),
                    max_position_size: parseFloat(document.getElementById('edMaxSize').value || '0.2'),
                    stop_loss: parseFloat(document.getElementById('edSL').value || '0.04'),
                    take_profit: parseFloat(document.getElementById('edTP').value || '0.08'),
                    commission: parseFloat(document.getElementById('edFee').value || '0.004'),
                    slippage: parseFloat(document.getElementById('edSlip').value || '0.001'),
                },
                strategy_params: parseParamsKV(document.getElementById('edParams').value)
            };
            // client validation
            const errs = [];
            if (payload.loop_sleep <= 0 || payload.loop_sleep > 120) errs.push('Loop sleep must be 0-120s');
            if (!(payload.risk.max_position_size > 0 && payload.risk.max_position_size <= 1)) errs.push('Max size must be in (0,1]');
            ['stop_loss','take_profit','commission','slippage'].forEach(k=>{ const v = payload.risk[k]; if (!(v >= 0 && v < 1)) errs.push(`risk.${k} must be in [0,1)`); });
            if (errs.length){ alert('Validation: ' + errs.join(' | ')); return; }
            try {
                await fetch('/api/bots', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                document.getElementById('dupId').value = `${newId}_copy`;
                loadBots();
            } catch (e) { console.error('duplicate failed', e); }
        }

        // Toasts
        function showToast(msg, type='info') {
            const wrap = document.getElementById('toasts');
            if (!wrap) return;
            const div = document.createElement('div');
            div.className = 'toast ' + (type==='error' ? 'toast-error' : (type==='success' ? 'toast-success' : 'toast-info'));
            div.textContent = msg;
            wrap.appendChild(div);
            setTimeout(() => { div.remove(); }, 3000);
        }


        function setTab(tab) {
            activeTab = tab;
            localStorage.setItem('activeTab', tab);
            const showOverview = (tab === 'overview');
            const showBots = (tab === 'bots');
            const showSess = (tab === 'sessions');
            const ovTop = document.getElementById('overview-top');
            const ovBot = document.getElementById('overview-bottom');
            const bots = document.getElementById('section-bots');
            const sess = document.getElementById('section-sessions');
            if (ovTop) ovTop.style.display = showOverview ? '' : 'none';
            if (ovBot) ovBot.style.display = showOverview ? '' : 'none';
            if (bots) bots.style.display = showBots ? '' : 'none';
            if (sess) sess.style.display = showSess ? '' : 'none';
        }

        function updateDashboard(data) {
            const metrics = data.metrics || {};
            
            // Update metrics
            document.getElementById('equity').textContent = `$${(metrics.equity || 0).toFixed(2)}`;
            
            const returnEl = document.getElementById('totalReturn');
            const returnValue = metrics.total_return || 0;
            returnEl.textContent = `${returnValue >= 0 ? '+' : ''}${returnValue.toFixed(2)}%`;
            returnEl.className = `metric-value ${returnValue >= 0 ? 'positive' : 'negative'}`;
            
            const winRateEl = document.getElementById('winRate');
            const winRate = metrics.win_rate || 0;
            winRateEl.textContent = `${winRate.toFixed(1)}%`;
            winRateEl.className = `metric-value ${winRate >= 50 ? 'positive' : winRate >= 40 ? 'neutral' : 'negative'}`;
            
            document.getElementById('numTrades').textContent = metrics.num_trades || 0;
            document.getElementById('numPositions').textContent = metrics.num_positions || 0;
            
            const drawdownEl = document.getElementById('drawdown');
            const drawdown = metrics.drawdown || 0;
            drawdownEl.textContent = `${drawdown.toFixed(2)}%`;
            drawdownEl.className = `metric-value ${drawdown <= 5 ? 'positive' : drawdown <= 10 ? 'neutral' : 'negative'}`;

            // New rate metrics
            document.getElementById('tradesPerHour').textContent = `${(metrics.trades_per_hour || 0).toFixed(1)}`;
            document.getElementById('signalsPerHour').textContent = `${(metrics.signals_per_hour || 0).toFixed(1)}`;
            const execEl = document.getElementById('execRate');
            const exec = metrics.execution_rate || 0;
            execEl.textContent = `${exec.toFixed(1)}%`;
            execEl.className = `metric-value ${exec >= 50 ? 'positive' : exec >= 30 ? 'neutral' : 'negative'}`;
            
            // Update equity chart
            if (data.equity_history && data.equity_history.length > 0) {
                const labels = data.equity_history.map(point => {
                    const date = new Date(point.timestamp);
                    return date.toLocaleTimeString();
                });
                const values = data.equity_history.map(point => point.equity);
                
                chart.data.labels = labels;
                chart.data.datasets[0].data = values;
                chart.update();
            }

            // Session info
            const info = document.getElementById('sessionInfo');
            const cfg = data.config || {};
            const sym = (data.symbols || []).join(', ');
            const start = data.start_time ? new Date(data.start_time).toLocaleString() : 'Unknown';
            const end = data.end_time ? new Date(data.end_time).toLocaleString() : 'â€”';
            const fname = selectedFile || 'latest';
            info.innerHTML = `
                <div><b>File:</b> ${fname}</div>
                <div><b>Session:</b> ${data.session_name || 'â€”'}</div>
                <div><b>Strategy:</b> ${data.strategy || 'â€”'}</div>
                <div><b>Symbols:</b> ${sym || 'â€”'}</div>
                <div><b>Start:</b> ${start} &nbsp; <b>End:</b> ${end}</div>
                <div style="margin-top:8px"><b>Config:</b> 
                    mode=${cfg.signal_mode || 'n/a'}, max_pos=${cfg.max_positions || 'n/a'}, size=${cfg.max_position_size || 'n/a'}, 
                    sl=${cfg.stop_loss || 'n/a'}, tp=${cfg.take_profit || 'n/a'}, fee=${cfg.commission_rate || 'n/a'}, slip=${cfg.slippage_rate || 'n/a'}
                </div>
                <div style="margin-top:8px"><b>Signals:</b> 
                    B=${(data.signal_stats && data.signal_stats.buy_signals) || 0}, 
                    S=${(data.signal_stats && data.signal_stats.sell_signals) || 0}, 
                    H=${(data.signal_stats && data.signal_stats.hold_signals) || 0}, 
                    Exec=${(metrics.execution_rate || 0).toFixed(1)}%
                </div>
            `;
            
            // Update positions table
            updatePositionsTable(data.positions || {});
            
            // Update trades table
            updateTradesTable(data.trades || []);
        }
        
        function updatePositionsTable(positions) {
            const container = document.getElementById('positionsTable');
            
            if (Object.keys(positions).length === 0) {
                container.innerHTML = '<div class="no-data">No open positions</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Quantity</th>
                            <th>Entry</th>
                            <th>Current</th>
                            <th>P&L</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const [symbol, pos] of Object.entries(positions)) {
                const pnl = (pos.current_price - pos.entry_price) * pos.quantity;
                const pnlPct = ((pos.current_price - pos.entry_price) / pos.entry_price * 100);
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                
                html += `
                    <tr>
                        <td>${symbol}</td>
                        <td>${pos.quantity.toFixed(6)}</td>
                        <td>$${pos.entry_price.toFixed(2)}</td>
                        <td>$${pos.current_price.toFixed(2)}</td>
                        <td class="${pnlClass}">$${pnl.toFixed(2)} (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(1)}%)</td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function updateTradesTable(trades) {
            const container = document.getElementById('tradesTable');
            
            if (trades.length === 0) {
                container.innerHTML = '<div class="no-data">No trades yet</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>P&L</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Show last 10 trades
            const recentTrades = trades.slice(-10).reverse();
            
            for (const trade of recentTrades) {
                const time = new Date(trade.timestamp).toLocaleTimeString();
                const sideClass = trade.side === 'buy' ? 'buy' : 'sell';
                
                html += `
                    <tr>
                        <td>${time}</td>
                        <td>${trade.symbol}</td>
                        <td class="${sideClass}">${trade.side.toUpperCase()}</td>
                        <td>${trade.quantity.toFixed(6)}</td>
                        <td>$${trade.price.toFixed(2)}</td>
                        <td class="${trade.pnl >= 0 ? 'positive' : 'negative'}">
                            ${trade.pnl !== undefined ? `$${trade.pnl.toFixed(2)}` : '-'}
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Auto-refresh handling
        function resetInterval() {
            if (updateInterval) clearInterval(updateInterval);
            const enabled = document.getElementById('autoRefresh').checked;
            const secs = Math.max(1, parseInt(document.getElementById('refreshInterval').value || '3', 10));
            if (enabled) {
                updateInterval = setInterval(loadData, secs * 1000);
            }
        }

        // Initial load
        (async function init() {
            await fetchSessions();
            const sel = document.getElementById('sessionSelect');
            sel.addEventListener('change', () => { selectedFile = sel.value; localStorage.setItem('sessionFile', selectedFile); loadData(); });
            document.getElementById('autoRefresh').addEventListener('change', resetInterval);
            document.getElementById('refreshInterval').addEventListener('change', resetInterval);
            resetInterval();
            loadData();
            loadBots();
            // Poll bots every 5s
            botsInterval = setInterval(loadBots, 5000);
            // Tabs
            const tb = document.getElementById('tab-overview');
            if (tb) {
                document.getElementById('tab-overview').addEventListener('click', ()=>setTab('overview'));
                document.getElementById('tab-bots').addEventListener('click', ()=>setTab('bots'));
                document.getElementById('tab-sessions').addEventListener('click', ()=>setTab('sessions'));
                setTab(activeTab);
            }
        })();

        async function loadBotEvents() {
            const id = document.getElementById('eventsBotId').value.trim();
            if (!id) return;
            const limit = parseInt(document.getElementById('eventsLimit').value || '50', 10);
            const types = (document.getElementById('eventsTypes')?.value || '').trim();
            try {
                const q = types ? `&types=${encodeURIComponent(types)}` : '';
                const resp = await fetch(`/api/bots/${id}/events?limit=${limit}${q}`);
                const data = await resp.json();
                renderEvents(data.events || []);
            } catch (e) { console.error('events failed', e); }
        }

        

        function moreEvents() {
            const el = document.getElementById('eventsLimit');
            const v = parseInt(el.value || '50', 10);
            el.value = Math.min(v + 100, 1000);
            loadBotEvents();
        }
function renderEvents(evts) {
            const container = document.getElementById('botEvents');
            if (!evts.length) { container.innerHTML = '<div class="no-data">No events</div>'; return; }
            let html = `<table><thead><tr><th>Time</th><th>Type</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Price</th><th>PNL</th><th>Info</th></tr></thead><tbody>`;
            for (const e of evts.slice().reverse()) {
                const t = e.time ? new Date(e.time).toLocaleTimeString() : '';
                html += `<tr>
                    <td>${t}</td>
                    <td>${e.type || ''}</td>
                    <td>${e.symbol || ''}</td>
                    <td>${e.side || ''}</td>
                    <td>${e.quantity !== undefined ? Number(e.quantity).toFixed(6) : ''}</td>
                    <td>${e.price !== undefined ? \`$\${Number(e.price).toFixed(2)}\` : ''}</td>
                    <td>${e.pnl !== undefined ? (Number(e.pnl) >= 0 ? '+' : '-') + \`$\${Math.abs(Number(e.pnl)).toFixed(2)}\` : ''}</td>
                    <td>${e.reason || e.message || ''}</td>
                </tr>`;
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }


    </script>
</body>
</html>

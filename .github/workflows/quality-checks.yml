name: Quality Checks

on:
  workflow_call:
    inputs:
      python-version:
        type: string
        default: "3.12"
      security-severity:
        type: string
        default: "medium"
      upload-reports:
        type: boolean
        default: false

permissions:
  contents: read

defaults:
  run:
    shell: bash --noprofile --norc {0}

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Prepare Python environment
        uses: ./.github/actions/setup-uv
        with:
          python-version: ${{ inputs.python-version }}

      - name: Lint with Ruff
        run: |
          set -euo pipefail
          uv run ruff check .

      - name: Check formatting with Black
        run: |
          set -euo pipefail
          uv run black --check .

      - name: Type-check with MyPy
        id: mypy
        continue-on-error: true
        run: |
          set -euo pipefail
          uv run mypy src/gpt_trader/ 2>&1 | tee mypy-output.txt || true

          # Count errors for summary
          error_count=$(grep -c "^src/gpt_trader" mypy-output.txt || echo "0")
          echo "error_count=$error_count" >> $GITHUB_OUTPUT

          # Fail step if errors found (but continue-on-error allows workflow to proceed)
          if [ "$error_count" -gt 0 ]; then
            echo "::warning::MyPy found $error_count type errors"
            exit 1
          fi

      - name: Add MyPy results to summary
        if: always() && steps.mypy.outcome == 'failure'
        run: |
          echo "### MyPy Type Errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -50 mypy-output.txt >> $GITHUB_STEP_SUMMARY
          if [ $(wc -l < mypy-output.txt) -gt 50 ]; then
            echo "... (truncated, see full output in job logs)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Security scan with Bandit
        run: |
          set -euo pipefail
          uv run bandit -r src/gpt_trader/ \
            --severity-level ${{ inputs.security-severity }} \
            --confidence-level ${{ inputs.security-severity }} \
            -f json -o bandit-report.json

      - name: Dependency audit with pip-audit
        run: |
          set -euo pipefail
          uv run pip-audit -f json -o pip-audit-report.json --ignore-vuln GHSA-4xh5-x5gv-qwph || echo "pip-audit completed with warnings"

      - name: Upload security reports
        if: inputs.upload-reports && always()
        uses: actions/upload-artifact@v5
        with:
          name: security-reports
          path: |
            bandit-report.json
            pip-audit-report.json
          retention-days: 30

# Operational Directory Retention Policy

**Last Updated:** 2025-10-05
**Owner:** Operations Team
**Status:** Active
**Review Cadence:** Quarterly

---

## Overview

This policy defines lifecycle management, retention periods, and cleanup procedures for all operational directories in the GPT-Trader project. Proper retention balances disk space management with operational recovery needs.

---

## Policy Summary

| Directory | Status | Retention Period | Lifecycle | Recovery SLA |
|-----------|--------|------------------|-----------|--------------|
| `backups/` | ACTIVE | 30 days rolling | runtime → archival → deletion | 24 hours |
| `logs/` | ACTIVE | 14 days rolling | runtime → deletion | N/A (logs not recoverable) |
| `cache/` | ACTIVE | 7 days rolling | runtime → deletion | N/A (ephemeral) |
| `data/` | ACTIVE | Permanent | runtime → archival | 24 hours |
| `data_storage/` | ARCHIVAL | 90 days rolling | archival → deletion | 48 hours |
| `.mypy_cache/` | TOOL | On-demand | ephemeral | N/A (regenerated) |
| `.pytest_cache/` | TOOL | On-demand | ephemeral | N/A (regenerated) |
| `.ruff_cache/` | TOOL | On-demand | ephemeral | N/A (regenerated) |

---

## 1. backups/ - State Backup Directory

### Purpose
Stores automated state backups generated by BackupScheduler for disaster recovery and state restoration.

### Current State
- **Managed By:** `src/bot_v2/state/backup/scheduler.py` (BackupScheduler)
- **Timestamp Pattern:** `YYYYMMDD_HHMMSS` (e.g., `20251004_151054`)
- **Current Count:** 8 timestamped directories (as of Oct 5, 2025)
- **Storage Path (S3):** `backups/{backup_id}.backup` (per transport.py:158)

### Lifecycle

**Runtime Phase:**
- Backups created on schedule by BackupScheduler (full, differential, incremental)
- Timestamped directories created in `backups/`
- Immediate availability for recovery operations

**Archival Phase (After 7 Days):**
- Compress backup directories: `tar -czf backups/archive/20251004_151054.tar.gz backups/20251004_151054/`
- Move to `backups/archive/`
- Delete original uncompressed directory
- Update manifest: `backups/archive/MANIFEST.json`

**Deletion Phase (After 30 Days):**
- Delete archived backups older than 30 days
- Trigger: Age-based (30 days from creation date)
- Exception: Keep monthly snapshots (1st of each month) for 1 year
- Audit trail: Log deletion to `backups/retention_audit.log`

### Retention Rules

**Retention Period:** 30 days rolling window

**Triggers:**
- **Age-based:** Delete backups >30 days old
- **Size-based:** If total backup size >100GB, delete oldest backups first until <80GB
- **Event-based:** After successful deployment, mark pre-deployment backup as "critical" (retain for 90 days)

**Exceptions (Keep Longer):**
- Monthly snapshots (1st of month): Retain 1 year
- Pre-deployment backups: Retain 90 days
- Post-incident backups: Retain until incident post-mortem complete

### Recovery SLA

**Target:** 24 hours to restore from any backup within retention window

**Procedure:**
1. Identify backup timestamp: `ls -lh backups/ | grep 20251004`
2. Restore using BackupScheduler: `poetry run perps-bot --restore-backup 20251004_151054`
3. Validate state integrity: `pytest -m state_management`
4. Resume operations

### Audit Trail

All deletions logged to `backups/retention_audit.log`:
```json
{
  "timestamp": "2025-10-05T14:30:00Z",
  "action": "delete",
  "target": "backups/20250905_120000/",
  "reason": "age-based (>30 days)",
  "size_freed_mb": 1250,
  "operator": "cleanup_artifacts.sh"
}
```

---

## 2. logs/ - Application Logs

### Purpose
Stores runtime application logs for debugging, monitoring, and operational diagnostics.

### Current State
- **Status:** Empty (as of Oct 5, 2025)
- **Expected Usage:** Runtime logs when bot is running

### Lifecycle

**Runtime Phase:**
- Logs written to `logs/perps_bot_YYYYMMDD.log` (daily rotation)
- Real-time tailing for monitoring: `tail -f logs/perps_bot_20251005.log`

**Deletion Phase (After 14 Days):**
- Delete log files older than 14 days
- No archival (logs not designed for long-term storage)
- Operational metrics should be in monitoring system (Prometheus/Grafana)

### Retention Rules

**Retention Period:** 14 days rolling window

**Triggers:**
- **Age-based:** Delete logs >14 days old
- **Size-based:** If total log size >10GB, delete oldest logs until <5GB

**Exceptions:**
- Incident-related logs: Copy to `logs/incidents/YYYY-MM-DD/` before deletion, retain 90 days
- Error logs: Severity ≥ERROR extracted to separate retention (30 days)

### Recovery SLA

N/A - Logs are not recoverable after deletion. Critical events should be:
1. Captured in monitoring system (Prometheus)
2. Alerted via Alertmanager
3. Documented in incident reports

### Cleanup Commands

```bash
# Delete logs older than 14 days
find logs/ -name "*.log" -type f -mtime +14 -delete

# Archive incident logs before cleanup
mkdir -p logs/incidents/$(date +%Y-%m-%d)/
cp logs/perps_bot_*_ERROR.log logs/incidents/$(date +%Y-%m-%d)/ 2>/dev/null || true
```

---

## 3. cache/ - Application Cache

### Purpose
Stores temporary cached data for performance optimization (API responses, computed results, etc.).

### Current State
- **Status:** Empty (as of Oct 5, 2025)
- **Expected Usage:** Runtime caching when enabled

### Lifecycle

**Runtime Phase:**
- Cache files written with TTL metadata
- Cache hit/miss tracked in application metrics

**Deletion Phase (After 7 Days):**
- Delete cache files older than 7 days
- No archival (cache is ephemeral by design)

### Retention Rules

**Retention Period:** 7 days rolling window

**Triggers:**
- **Age-based:** Delete cache >7 days old
- **Size-based:** If total cache >5GB, evict LRU entries until <3GB
- **Event-based:** Clear cache on deployment (optional, configurable)

**Exceptions:** None - cache is always safe to delete

### Recovery SLA

N/A - Cache is regenerated on demand. No recovery needed.

### Cleanup Commands

```bash
# Safe to delete entire cache directory
rm -rf cache/*

# Age-based cleanup (7 days)
find cache/ -type f -mtime +7 -delete
```

---

## 4. data/ - Trading Data

### Purpose
Stores critical trading data including universe definitions, symbol mappings, and configuration.

### Current State
- **Status:** ACTIVE
- **Subdirectories:** `data/universe/` (contains trading universe definitions)

### Lifecycle

**Runtime Phase:**
- Trading universe data loaded on bot startup
- Referenced by strategy selectors and risk management
- Modified infrequently (configuration changes, universe updates)

**Archival Phase:**
- Version-controlled via git (no separate archival)
- Historical snapshots via git tags on deployment

**Deletion Phase:**
- **NEVER AUTO-DELETE** - data/ is permanent
- Manual deletion only after explicit approval

### Retention Rules

**Retention Period:** Permanent (no automatic deletion)

**Backup:**
- Version-controlled in git repository
- Included in state backups (BackupScheduler)
- S3 sync for off-site redundancy: `aws s3 sync data/ s3://gpt-trader-data/`

### Recovery SLA

**Target:** 24 hours to restore from git or S3 backup

**Procedure:**
1. Restore from git: `git checkout <commit> -- data/`
2. Or restore from S3: `aws s3 sync s3://gpt-trader-data/ data/`
3. Validate integrity: `pytest tests/integration/test_universe_loading.py`

### Audit Trail

Changes tracked via git:
```bash
git log --oneline -- data/
```

---

## 5. data_storage/ - Archival Storage

### Purpose
Long-term storage for historical market data (OHLCV, metadata) used in backtesting and analysis.

### Current State
- **Status:** ARCHIVAL (empty subdirectories as of Oct 5)
- **Subdirectories:** `data_storage/metadata/`, `data_storage/ohlcv/`

### Lifecycle

**Runtime Phase:**
- Historical data loaded for backtesting
- Rarely accessed in production trading

**Archival Phase:**
- Data older than 90 days compressed and archived to S3
- Local copies deleted after S3 confirmation

**Deletion Phase (After 90 Days):**
- Delete local copies older than 90 days
- S3 archival retained indefinitely (Glacier storage class)

### Retention Rules

**Retention Period:** 90 days local, indefinite S3 archival

**Triggers:**
- **Age-based:** Archive to S3 after 90 days, delete local copy
- **Size-based:** If local storage >50GB, archive oldest data first

**S3 Archival:**
```bash
# Compress and upload to S3
tar -czf ohlcv_archive_$(date +%Y%m).tar.gz data_storage/ohlcv/
aws s3 cp ohlcv_archive_$(date +%Y%m).tar.gz s3://gpt-trader-archives/ --storage-class GLACIER

# Verify upload, then delete local
aws s3 ls s3://gpt-trader-archives/ohlcv_archive_$(date +%Y%m).tar.gz && rm -rf data_storage/ohlcv/*
```

### Recovery SLA

**Target:** 48 hours to restore from S3 Glacier (retrieval time 12-48 hours)

**Procedure:**
1. Request Glacier retrieval: `aws s3api restore-object --bucket gpt-trader-archives --key ohlcv_archive_YYYYMM.tar.gz --restore-request Days=7`
2. Wait 12-48 hours for retrieval
3. Download and extract: `aws s3 cp s3://gpt-trader-archives/ohlcv_archive_YYYYMM.tar.gz . && tar -xzf ohlcv_archive_YYYYMM.tar.gz`

---

## 6. Tool Caches (.mypy_cache, .pytest_cache, .ruff_cache)

### Purpose
Development tool caches for faster execution (type checking, testing, linting).

### Lifecycle

**Runtime Phase:**
- Regenerated automatically by tools (mypy, pytest, ruff)
- Improves performance on repeated runs

**Deletion Phase:**
- On-demand cleanup when cache becomes stale or corrupted
- Automatically cleared by tools when version changes

### Retention Rules

**Retention Period:** On-demand (no scheduled cleanup)

**Triggers:**
- Manual cleanup: `make clean-cache` or `find . -name "*cache" -type d -exec rm -rf {} +`
- Tool version upgrade (auto-cleared by tool)
- Disk space emergency

### Recovery SLA

N/A - Caches regenerated automatically on next tool run

### .gitignore

**MUST be excluded from version control:**
```gitignore
.mypy_cache/
.pytest_cache/
.ruff_cache/
__pycache__/
*.pyc
*.pyo
```

---

## Cleanup Script: cleanup_artifacts.sh

### Usage

```bash
# Dry-run mode (default, no deletions)
./scripts/cleanup_artifacts.sh --dry-run

# Interactive confirmation mode
./scripts/cleanup_artifacts.sh --confirm

# Automated mode (requires explicit age thresholds)
./scripts/cleanup_artifacts.sh --age-threshold-days 30 --backup-first

# Exclude patterns
./scripts/cleanup_artifacts.sh --exclude-patterns "*.critical,monthly_*"
```

### Safety Features

1. **--dry-run** (default): Show what would be deleted, make no changes
2. **--confirm**: Prompt for confirmation before each deletion
3. **--age-threshold-days**: Only delete files older than N days
4. **--backup-first**: Create archive before deletion
5. **--exclude-patterns**: Comma-separated patterns to preserve
6. **Rollback test**: Verify backups can be restored before deleting

### Implementation (Week 2 Deliverable)

Script will be created at `scripts/cleanup_artifacts.sh` with:
- Dry-run mode as default
- Comprehensive logging to `logs/cleanup_audit.log`
- Pre-flight checks (directory exists, permissions OK)
- Post-cleanup verification (expected files preserved)
- Integration with retention policy rules

---

## Operational Checklist

### Daily
- [ ] Monitor disk usage: `df -h | grep -E 'backups|logs|cache'`
- [ ] Check backup creation: `ls -lt backups/ | head -5`

### Weekly
- [ ] Review cleanup audit logs: `tail -100 logs/cleanup_audit.log`
- [ ] Validate backup count within policy: `find backups/ -maxdepth 1 -type d | wc -l` (should be ≤30)

### Monthly
- [ ] Execute cleanup script: `./scripts/cleanup_artifacts.sh --confirm`
- [ ] Verify monthly backup archived: `ls backups/archive/ | grep $(date +%Y%m)01`
- [ ] Test backup restoration: `poetry run perps-bot --restore-backup <latest> --dry-run`

### Quarterly
- [ ] Review retention policy effectiveness
- [ ] Update retention periods based on operational needs
- [ ] Audit S3 archival costs and usage
- [ ] Update this document with lessons learned

---

## Exceptions & Override Process

**Exception Request Template:**
```markdown
## Retention Exception Request

**Directory:** backups/20250101_120000/
**Current Retention:** 30 days
**Requested Retention:** 1 year
**Reason:** Pre-production launch backup, regulatory requirement
**Approved By:** [Name, Title]
**Review Date:** 2026-01-01
```

**Approval Required:**
- Operations Lead (all exceptions)
- Architecture Lead (data/ exceptions)
- Trading Ops Lead (backups/ exceptions >90 days)

---

## Related Documents

- [CLEANUP_CHECKLIST.md](CLEANUP_CHECKLIST.md) - Operational audit plan
- [CODEBASE_HEALTH_ASSESSMENT.md](CODEBASE_HEALTH_ASSESSMENT.md) - Directory health status
- [BACKUP_SYSTEM_ARCHITECTURE.md](../architecture/BACKUP_SYSTEM_ARCHITECTURE.md) - Backup design
- [dependency_policy.md](dependency_policy.md) - Dependency management

---

## Revision History

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2025-10-05 | 1.0 | Initial policy creation | Architecture Team |

**Next Review:** 2026-01-05

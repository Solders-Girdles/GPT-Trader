name: Python CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write
  checks: write

defaults:
  run:
    shell: bash --noprofile --norc {0}

env:
  PYTHON_VERSION: "3.12"

jobs:
  # Reusable quality checks (linting, formatting, security)
  quality:
    name: Quality Checks
    uses: ./.github/workflows/quality-checks.yml
    with:
      python-version: "3.12"
      security-severity: "medium"

  core-checks:
    name: Core Checks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Runs in parallel with quality checks for faster CI

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Prepare Python environment
      id: setup-uv
      uses: ./.github/actions/setup-uv
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Generate dependency artifacts
      if: github.event_name == 'pull_request'
      run: |
        set -euo pipefail
        uv run python scripts/analysis/dependency_map.py --tests "tests/**/*.py" --output dependency_report.json
        uv run python scripts/analysis/test_categorizer.py --output test_categories.json

    - name: Run selective tests
      if: github.event_name == 'pull_request'
      env:
        PYTEST_ADDOPTS: '-m "not slow and not performance" -q'
        BASE_REF: ${{ github.event.pull_request.base.ref }}
      run: |
        set -euo pipefail
        git fetch origin "$BASE_REF" --depth=1
        CHANGED=$(git diff --name-only "origin/$BASE_REF" HEAD -- '*.py' | tr '\n' ' ')
        if [ -z "$CHANGED" ]; then
          uv run python scripts/testing/selective_runner.py \
            --deps dependency_report.json \
            --categories test_categories.json \
            --max-selective-ratio 0.7 \
            --auto-full-module gpt_trader.features.brokerages.core.interfaces
        else
          uv run python scripts/testing/selective_runner.py \
            --deps dependency_report.json \
            --categories test_categories.json \
            --paths $CHANGED \
            --max-selective-ratio 0.7 \
            --auto-full-module gpt_trader.features.brokerages.core.interfaces
        fi

    - name: Check naming standards
      run: |
        set -euo pipefail
        uv run python scripts/agents/naming_inventory.py \
          --summary naming_inventory.md \
          --json naming_inventory.json

        # Display summary in job log
        if [ -f naming_inventory.md ]; then
          echo "::group::Naming Inventory Summary"
          cat naming_inventory.md
          echo "::endgroup::"
        fi

    - name: Upload naming inventory report
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: naming-inventory-report
        path: |
          naming_inventory.md
          naming_inventory.json
        retention-days: 30

    - name: Verify agent context freshness
      run: |
        set -euo pipefail
        # Regenerate agent context files
        uv run python scripts/agents/regenerate_all.py || true

        # Check for uncommitted changes in var/agents/
        if ! git diff --quiet var/agents/; then
          echo "::warning::Agent context files may be stale. Run 'uv run agent-regenerate' and commit changes."
          git diff --stat var/agents/
        else
          echo "Agent context files are up to date."
        fi

    - name: Check test file complexity
      run: |
        set -euo pipefail
        uv run python scripts/analysis/check_complexity.py --path tests --max-lines 300

    - name: Verify uv lockfile in sync
      run: |
        set -euo pipefail
        uv lock --check

    - name: Run Coinbase core checks
      run: |
        set -euo pipefail
        uv run pytest tests/unit/gpt_trader/features/brokerages/coinbase -q

    - name: Run tests with pytest and generate coverage report
      if: github.event_name != 'pull_request'
      uses: nick-invision/retry@v3
      with:
        timeout_minutes: 15
        max_attempts: 2
        retry_wait_seconds: 5
        command: |
          uv run pytest -m "not slow and not performance and not integration" -q \
            --junitxml=test-results.xml \
            --cov=src \
            --cov-report=term-missing --cov-report=json:coverage.json --cov-report=xml --cov-report=html --cov-fail-under=23.50

    - name: Check coverage regression
      if: github.event_name != 'pull_request'
      run: |
        set -euo pipefail
        # Compare against baseline coverage.json if it exists
        if [ -f coverage.json ]; then
          uv run python -c "import json, sys; current=json.load(open('coverage.json')); overall_pct=current.get('totals', {}).get('percent_covered', 0); print(f\"Current overall coverage: {overall_pct:.2f}%\"); (overall_pct >= 23.50) or sys.exit(f\"ERROR: Coverage regression detected. Current: {overall_pct:.2f}%, Baseline: 23.50%\"); print('Coverage check passed.')"
        fi

    - name: Generate coverage delta for PR
      if: github.event_name == 'pull_request'
      env:
        BASE_REF: ${{ github.base_ref }}
      uses: nick-invision/retry@v3
      with:
        timeout_minutes: 15
        max_attempts: 2
        retry_wait_seconds: 5
        command: |
          uv run pytest -m "not slow and not performance and not integration" -q \
            --junitxml=test-results.xml \
            --cov=src --cov-report=xml
          uv run diff-cover coverage.xml \
            --compare-branch="origin/$BASE_REF" \
            --fail-under=70 || echo "::warning::Coverage delta below 70% threshold"

    - name: Upload coverage to Artifacts
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v5
      with:
        name: coverage-xml
        path: coverage.xml

    - name: Upload HTML coverage report
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v5
      with:
        name: coverage-html
        path: htmlcov

    - name: Publish test results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: test-results.xml
        check_name: 'Test Results'
        comment_mode: 'off'

  config-modes:
    name: Config Mode Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        env_mode: ['prod', 'sandbox', 'prod_fallback', 'sandbox_fallback']

    steps:
    - uses: actions/checkout@v6

    - name: Prepare Python environment
      id: setup-uv
      uses: ./.github/actions/setup-uv
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Configure Coinbase credentials
      uses: ./.github/actions/setup-coinbase-creds
      with:
        mode: ${{ matrix.env_mode }}

    - name: Run config tests
      env:
        BROKER: coinbase
      run: |
        set -euo pipefail
        uv run pytest tests/unit/gpt_trader/config/test_config_utilities.py tests/unit/gpt_trader/features/live_trade/test_config_dict_json.py -v

# =============================================================================
# GPT-TRADER DEVELOPMENT CONFIGURATION TEMPLATE
# =============================================================================
# Copy this file to `.env` for local development. Secrets should remain outside
# version control (use `.env.local`, direnv, or your vault of choice).
# =============================================================================

# -----------------------------------------------------------------------------
# CORE SETTINGS
# -----------------------------------------------------------------------------
BROKER=coinbase
PERPS_PAPER=1                # Leave enabled for local testing (no real orders)
LOG_LEVEL=INFO
COINBASE_TRADER_DEBUG=0      # Enable verbose debug output when set to 1
ENV=development              # Environment label used by tooling/logging
RISK_CONFIG_PATH=            # Optional path to risk overrides (see docs/reference/risk_templates/)

# Broker Mode
MOCK_BROKER=0                # Use mock/deterministic broker (1=mock, 0=real)
DRY_RUN=0                    # Run without placing real orders
STATUS_ENABLED=1             # Enable status file updates
BROKER_CALLS_USE_DEDICATED_EXECUTOR=0  # Use a dedicated thread pool for broker calls (1=on, 0=off)

# Trading Modes (comma-separated: spot, cfm)
TRADING_MODES=spot           # Which markets to trade: "spot", "cfm", or "spot,cfm"
CFM_ENABLED=0                # Enable CFM (Coinbase Financial Markets) futures

# INTX perps (international) flags
COINBASE_ENABLE_INTX_PERPS=0

# -----------------------------------------------------------------------------
# COINBASE CREDENTIALS
# -----------------------------------------------------------------------------
# Advanced Trade has no authenticated sandbox; use the mock broker for paper testing.
COINBASE_API_MODE=advanced
COINBASE_SANDBOX=1

# Preferred: JSON key file
COINBASE_CREDENTIALS_FILE=
# Or set both env vars:
# COINBASE_CDP_API_KEY=
# COINBASE_CDP_PRIVATE_KEY=
# Production INTX credentials:
# COINBASE_PROD_CDP_API_KEY=
# COINBASE_PROD_CDP_PRIVATE_KEY=
# Legacy fallback (still supported):
# COINBASE_API_KEY_NAME=
# COINBASE_PRIVATE_KEY=

# -----------------------------------------------------------------------------
# ORDER EXECUTION SAFETY
# -----------------------------------------------------------------------------
ORDER_PREVIEW_ENABLED=1
ORDER_PREVIEW_FAIL_CLOSED=1
DEFAULT_ORDER_TYPE=limit
DEFAULT_TIME_IN_FORCE=GTC
ORDER_POST_ONLY=0
ORDER_REDUCE_ONLY_DEFAULT=0
MIN_ORDER_SIZE_USD=25
MAX_ORDER_SIZE_USD=2500
# Retry order submissions on transient broker/network failures (off by default).
ORDER_SUBMISSION_RETRIES_ENABLED=0
ORDER_MAX_RETRIES=1
ORDER_RETRY_DELAY_MS=750

# -----------------------------------------------------------------------------
# RISK MANAGEMENT
# -----------------------------------------------------------------------------
RISK_MAX_LEVERAGE=3
RISK_MAX_EXPOSURE_PCT=0.30
RISK_MAX_POSITION_PCT_PER_SYMBOL=0.10
# Daily loss limit as percentage of equity (0.05 = 5%)
# When daily loss exceeds this, reduce-only mode is triggered
RISK_DAILY_LOSS_LIMIT_PCT=0.05
# Legacy absolute dollar limit (kept for compatibility; used by preflight env checks)
RISK_DAILY_LOSS_LIMIT=100
RISK_MIN_LIQUIDATION_BUFFER_PCT=0.20
RISK_ENABLE_PRE_TRADE_LIQ_PROJECTION=1
RISK_MAX_MARK_STALENESS_SECONDS=120
RISK_SLIPPAGE_GUARD_BPS=40
RISK_KILL_SWITCH_ENABLED=0
RISK_REDUCE_ONLY_MODE=0

# Optional per-symbol overrides.
RISK_LEVERAGE_MAX_PER_SYMBOL=
RISK_MAX_NOTIONAL_PER_SYMBOL=

# Volatility circuit breaker (optional).
RISK_ENABLE_VOLATILITY_CB=0
RISK_MAX_INTRADAY_VOL=0.18
RISK_VOL_WINDOW_PERIODS=20
RISK_CB_COOLDOWN_MIN=30
RISK_VOL_WARNING_THRESH=0.18

# API Health Guard Thresholds
# Triggers reduce-only mode when API is degraded
RISK_API_ERROR_RATE_THRESHOLD=0.2      # 20% error rate triggers guard
RISK_API_RATE_LIMIT_USAGE_THRESHOLD=0.9 # 90% rate limit usage triggers guard
RISK_VOL_REDUCE_ONLY_THRESH=0.22
RISK_VOL_KILL_SWITCH_THRESH=0.26

# Graceful Degradation Settings
# Controls how the system responds to failures (pause, reduce-only, etc.)
RISK_API_HEALTH_COOLDOWN_SECONDS=300         # Pause after API health trip (5 min)
RISK_MARK_STALENESS_COOLDOWN_SECONDS=120     # Pause symbol on stale mark (2 min)
RISK_MARK_STALENESS_ALLOW_REDUCE_ONLY=1      # Allow reduce-only during stale mark
RISK_SLIPPAGE_FAILURE_PAUSE_AFTER=3          # Pause symbol after N slippage failures
RISK_SLIPPAGE_PAUSE_SECONDS=60               # Slippage pause duration per symbol
RISK_VALIDATION_FAILURE_COOLDOWN_SECONDS=180 # Pause on validation infra failure
RISK_PREVIEW_FAILURE_DISABLE_AFTER=5         # Disable preview after N failures
RISK_BROKER_OUTAGE_MAX_FAILURES=3            # Pause after N broker read failures
RISK_BROKER_OUTAGE_COOLDOWN_SECONDS=120      # Broker outage pause duration

# WebSocket Health Monitoring
# Controls staleness detection and health watchdog intervals
RISK_WS_HEALTH_INTERVAL_SECONDS=5            # How often to poll WS health
RISK_WS_MESSAGE_STALE_SECONDS=15             # Max age of last WS message before stale
RISK_WS_HEARTBEAT_STALE_SECONDS=30           # Max age of last heartbeat before stale
RISK_WS_RECONNECT_PAUSE_SECONDS=30           # Pause after WS reconnect

# WebSocket Reconnection Tuning
# Exponential backoff with jitter for robust reconnection handling
GPT_TRADER_WS_RECONNECT_BACKOFF_BASE=2.0     # Base delay in seconds
GPT_TRADER_WS_RECONNECT_BACKOFF_MAX=60.0     # Max delay cap in seconds
GPT_TRADER_WS_RECONNECT_BACKOFF_MULTIPLIER=2.0  # Backoff multiplier
GPT_TRADER_WS_RECONNECT_JITTER_PCT=0.25      # Jitter Â±25% to prevent thundering herd
GPT_TRADER_WS_RECONNECT_MAX_ATTEMPTS=10      # Max attempts before degradation (0=unlimited)
GPT_TRADER_WS_RECONNECT_RESET_SECONDS=60.0   # Stable time to reset attempt counter
GPT_TRADER_WS_RECONNECT_PAUSE_SECONDS=300    # Pause duration after max attempts exceeded

# -----------------------------------------------------------------------------
# MONITORING & STREAMING
# -----------------------------------------------------------------------------
PERPS_ENABLE_STREAMING=0
COINBASE_WS_USER_AUTH=0
PERPS_STREAM_LEVEL=1
COINBASE_TRADER_METRIC_PREFIX=coinbase_trader   # Optional Prometheus prefix override

# -----------------------------------------------------------------------------
# OBSERVABILITY (METRICS & TRACING)
# -----------------------------------------------------------------------------
# Prometheus /metrics endpoint on health server (default: disabled)
GPT_TRADER_METRICS_ENDPOINT_ENABLED=0

# OpenTelemetry tracing (default: disabled)
GPT_TRADER_OTEL_ENABLED=0
OTEL_SERVICE_NAME=gpt-trader
# OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317   # Uncomment to export traces

# Health check runner cadence
GPT_TRADER_HEALTH_CHECK_INTERVAL=30.0   # Seconds between health checks

# API Resilience Features (all enabled by default)
GPT_TRADER_CACHE_ENABLED=1              # Response caching for stable data
GPT_TRADER_CIRCUIT_BREAKER_ENABLED=1    # Prevent hammering failing endpoints
GPT_TRADER_PRIORITY_ENABLED=1           # Prioritize critical requests under pressure
GPT_TRADER_ADAPTIVE_THROTTLE=1          # Proactive pacing instead of reactive blocking
GPT_TRADER_METRICS_ENABLED=1            # In-memory metrics collection

# -----------------------------------------------------------------------------
# LOGGING (ROTATING FILE HANDLERS)
# -----------------------------------------------------------------------------
COINBASE_TRADER_LOG_DIR=var/log/coinbase_trader
COINBASE_TRADER_LOG_MAX_BYTES=5242880       # 5 MB per log file
COINBASE_TRADER_LOG_BACKUP_COUNT=3          # Retain 3 historical log files
COINBASE_TRADER_CRIT_LOG_MAX_BYTES=1048576  # 1 MB per critical log file
COINBASE_TRADER_CRIT_LOG_BACKUP_COUNT=5     # Retain 5 historical critical logs

# -----------------------------------------------------------------------------
# SECURITY & SECRETS (MANAGE VIA A SECURE STORE IN PRODUCTION)
# -----------------------------------------------------------------------------
# Store these outside version control. Example: export via CI secret manager or
# Vault; never commit real values.
JWT_SECRET_KEY=
GPT_TRADER_ENCRYPTION_KEY=
VAULT_ADDR=
VAULT_TOKEN=

# -----------------------------------------------------------------------------
# SYMBOLS & FEES
# -----------------------------------------------------------------------------
TRADING_SYMBOLS=BTC-PERP,ETH-PERP
FEE_BPS_BY_SYMBOL=BTC-PERP:6,ETH-PERP:8

# -----------------------------------------------------------------------------
# OPTIONAL RUNTIME FLAGS
# -----------------------------------------------------------------------------
# RISK_ENABLE_MARKET_IMPACT_GUARD=1
# RISK_MAX_MARKET_IMPACT_BPS=50
# RISK_ENABLE_DYNAMIC_POSITION_SIZING=0
# RISK_POSITION_SIZING_METHOD=notional
# RISK_POSITION_SIZING_MULTIPLIER=1.0
# SPOT_FORCE_LIVE=0
# COINBASE_DEFAULT_QUOTE=USD

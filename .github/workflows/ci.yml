name: Python CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: bash --noprofile --norc {0}

env:
  PYTHON_VERSION: "3.12"

jobs:
  core-checks:
    name: Core Checks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Prepare Python environment
      id: setup-poetry
      uses: ./.github/actions/setup-poetry
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Generate dependency artifacts
      if: github.event_name == 'pull_request'
      run: |
        set -euo pipefail
        poetry run python scripts/analysis/dependency_map.py --tests "tests/**/*.py" --output dependency_report.json
        poetry run python scripts/analysis/test_categorizer.py --output test_categories.json

    - name: Run selective tests
      if: github.event_name == 'pull_request'
      env:
        PYTEST_ADDOPTS: '-m "not slow and not performance" -q'
      run: |
        set -euo pipefail
        git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
        CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD -- '*.py' | tr '\n' ' ')
        if [ -z "$CHANGED" ]; then
          poetry run python scripts/testing/selective_runner.py \
            --deps dependency_report.json \
            --categories test_categories.json \
            --max-selective-ratio 0.7 \
            --auto-full-module gpt_trader.features.brokerages.core.interfaces
        else
          poetry run python scripts/testing/selective_runner.py \
            --deps dependency_report.json \
            --categories test_categories.json \
            --paths $CHANGED \
            --max-selective-ratio 0.7 \
            --auto-full-module gpt_trader.features.brokerages.core.interfaces
        fi

    - name: Lint with ruff
      run: |
        set -euo pipefail
        poetry run ruff check .

    - name: Check test file complexity
      run: |
        set -euo pipefail
        poetry run python scripts/analysis/check_complexity.py --path tests --max-lines 300

    - name: Check formatting with black
      run: |
        set -euo pipefail
        poetry run black --check .

    - name: Type-check with mypy
      continue-on-error: true  # TODO: Fix 337 pre-existing mypy errors and remove this
      run: |
        set -euo pipefail
        poetry run mypy src/gpt_trader || echo "::warning::mypy found type errors (see above)"

    - name: Run Bandit security scanner
      run: |
        set -euo pipefail
        poetry run bandit -r src/gpt_trader/ --severity-level medium --confidence-level medium

    - name: Run pip-audit for vulnerability scanning
      run: |
        set -euo pipefail
        poetry run pip-audit --ignore-vuln GHSA-4xh5-x5gv-qwph || echo "pip-audit completed with warnings"

    - name: Verify Poetry lockfile in sync
      run: |
        set -euo pipefail
        poetry check --lock

    - name: Run Coinbase core checks
      run: |
        set -euo pipefail
        poetry run pytest tests/unit/gpt_trader/features/brokerages/coinbase -q

    - name: Run tests with pytest and generate coverage report
      if: github.event_name != 'pull_request'
      run: |
        set -euo pipefail
        poetry run pytest -m "not slow and not performance and not integration" -q \
          --cov=src \
          --cov-report=term-missing --cov-report=json:coverage.json --cov-report=xml --cov-report=html --cov-fail-under=23.50

    - name: Check coverage regression
      if: github.event_name != 'pull_request'
      run: |
        set -euo pipefail
        # Compare against baseline coverage.json if it exists
        if [ -f coverage.json ]; then
          poetry run python -c "import json, sys; current=json.load(open('coverage.json')); overall_pct=current.get('totals', {}).get('percent_covered', 0); print(f\"Current overall coverage: {overall_pct:.2f}%\"); (overall_pct >= 23.50) or sys.exit(f\"ERROR: Coverage regression detected. Current: {overall_pct:.2f}%, Baseline: 23.50%\"); print('Coverage check passed.')"
        fi

    - name: Upload coverage to Artifacts
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-xml
        path: coverage.xml

    - name: Upload HTML coverage report
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-html
        path: htmlcov

  config-modes:
    name: Config Mode Coverage
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env_mode: ['prod', 'sandbox', 'prod_fallback', 'sandbox_fallback']

    steps:
    - uses: actions/checkout@v5

    - name: Prepare Python environment
      id: setup-poetry
      uses: ./.github/actions/setup-poetry
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Configure Coinbase credentials
      shell: bash
      env:
        ENV_MODE: ${{ matrix.env_mode }}
      run: |
        set -euo pipefail

        {
          echo "COINBASE_SANDBOX=0"
          echo "COINBASE_PROD_API_KEY="
          echo "COINBASE_PROD_API_SECRET="
          echo "COINBASE_SANDBOX_API_KEY="
          echo "COINBASE_SANDBOX_API_SECRET="
          echo "COINBASE_API_KEY="
          echo "COINBASE_API_SECRET="
        } >> "$GITHUB_ENV"

        case "$ENV_MODE" in
          prod)
            {
              echo "COINBASE_PROD_API_KEY=prod_key"
              echo "COINBASE_PROD_API_SECRET=prod_secret"
            } >> "$GITHUB_ENV"
            ;;
          sandbox)
            {
              echo "COINBASE_SANDBOX=1"
              echo "COINBASE_SANDBOX_API_KEY=sandbox_key"
              echo "COINBASE_SANDBOX_API_SECRET=sandbox_secret"
            } >> "$GITHUB_ENV"
            ;;
          prod_fallback)
            {
              echo "COINBASE_API_KEY=fallback_key"
              echo "COINBASE_API_SECRET=fallback_secret"
            } >> "$GITHUB_ENV"
            ;;
          sandbox_fallback)
            {
              echo "COINBASE_SANDBOX=1"
              echo "COINBASE_API_KEY=fallback_key"
              echo "COINBASE_API_SECRET=fallback_secret"
            } >> "$GITHUB_ENV"
            ;;
        esac

    - name: Run config tests
      env:
        BROKER: coinbase
      run: |
        set -euo pipefail
        poetry run pytest tests/unit/gpt_trader/config/test_config_utilities.py tests/unit/gpt_trader/features/live_trade/test_config_dict_json.py -v

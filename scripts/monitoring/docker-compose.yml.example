version: '3.8'

services:
  exporter:
    image: python:3.12-slim
    container_name: gpt-trader-exporter
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "pip install flask && python scripts/monitoring/export_metrics.py \
      --profile prod \
      --runtime-root /app \
      --host 0.0.0.0 --port 9000"
    volumes:
      - ../../:/app
    ports:
      - "9000:9000"

  prometheus:
    image: prom/prometheus:latest
    container_name: gpt-trader-prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus.yml.example:/etc/prometheus/prometheus.yml:ro
      - ./prometheus-alerts.yml.example:/etc/prometheus/alert.rules:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--web.enable-lifecycle"
    ports:
      - "9090:9090"
    depends_on:
      - exporter

  grafana:
    image: grafana/grafana:latest
    container_name: gpt-trader-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - grafana-storage:/var/lib/grafana
    depends_on:
      - prometheus

  loki:
    image: grafana/loki:2.9.3
    container_name: gpt-trader-loki
    restart: unless-stopped
    command: ["-config.file=/etc/loki/local-config.yaml"]
    volumes:
      - ./loki-config.yml.example:/etc/loki/local-config.yaml:ro
    ports:
      - "3100:3100"

  promtail:
    image: grafana/promtail:2.9.3
    container_name: gpt-trader-promtail
    restart: unless-stopped
    command: ["-config.file=/etc/promtail/config.yml"]
    volumes:
      - ./promtail-config.yml.example:/etc/promtail/config.yml:ro
      - ../../runtime_data/prod:/data/events:ro
    depends_on:
      - loki

volumes:
  grafana-storage:

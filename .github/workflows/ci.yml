name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Lint (Ruff)
        run: uv run ruff check .

      - name: Lint (Ruff - critical scripts)
        run: uv run ruff check scripts/ops scripts/backtest_runner.py scripts/perps_dashboard.py scripts/monitoring/export_metrics.py scripts/monitoring/canary_reduce_only_test.py scripts/monitoring/manage_logs.py scripts/production_preflight.py scripts/readiness_window.py scripts/test_api_connectivity.py scripts/test_paper_broker.py

      - name: Format (Black)
        run: uv run black --check .

      - name: Guard against orchestration imports (removed in v3.0)
        run: |
          # The gpt_trader.orchestration package was removed in v3.0
          # Fail if ANY file imports gpt_trader.orchestration
          if grep -rn -E "(from|import)\s+gpt_trader\.orchestration" src tests scripts --include="*.py"; then
            echo "::error::gpt_trader.orchestration was removed in v3.0"
            echo "Use canonical paths: app.*, features.live_trade.*, features.brokerages.*"
            echo "See docs/DEPRECATIONS.md for migration guidance."
            exit 1
          fi
          echo "No orchestration imports found - package was removed in v3.0."

      - name: Guard deprecation registry
        run: python scripts/ci/check_deprecation_registry.py

  docs-audit:
    name: Docs Link Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run markdown link audit
        run: python scripts/maintenance/docs_link_audit.py

      - name: Check docs reachability
        run: python scripts/maintenance/docs_reachability_check.py

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Type Check (MyPy)
        run: uv run mypy src

  agent-health:
    name: Agent Health
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run agent-health (fast, dev profile)
        run: |
          set -u
          set -o pipefail
          mkdir -p var/agents/health
          set +e
          make agent-health-fast AGENT_HEALTH_FAST_QUALITY_CHECKS=none
          status=$?
          set -e
          if [ -f var/agents/health/health_report.json ]; then
            uv run python - <<'PY' | tee var/agents/health/health_report.txt
          from scripts.agents.health_report import format_text_report
          import json
          with open("var/agents/health/health_report.json") as handle:
              report = json.load(handle)
          print(format_text_report(report))
          PY
          fi
          exit $status

      - name: Upload agent-health artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-health-report
          path: var/agents/health/health_report.json
          retention-days: 14

      - name: Add agent-health summary
        if: always()
        run: |
          if [ -f var/agents/health/health_report.txt ]; then
            echo "## Agent Health" >> $GITHUB_STEP_SUMMARY
            cat var/agents/health/health_report.txt >> $GITHUB_STEP_SUMMARY
          fi

  agent-freshness:
    name: Agent Artifacts Freshness
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Verify agent artifacts freshness
        id: verify
        run: |
          set +e
          set -o pipefail
          mkdir -p var/agents/health
          uv run agent-regenerate --verify | tee var/agents/health/agent_regenerate_verify.txt
          status=$?
          set +o pipefail
          set -e
          echo "exit_code=$status" >> $GITHUB_OUTPUT
          if [ $status -ne 0 ]; then
            echo "::warning::Agent artifacts are stale; run uv run agent-regenerate"
          fi

      - name: Add freshness summary
        if: always()
        run: |
          echo "## Agent Artifacts Freshness" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify.outputs.exit_code }}" != "0" ]; then
            echo "Status: STALE (run \`uv run agent-regenerate\`)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Status: OK" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f var/agents/health/agent_regenerate_verify.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            sed -n '1,40p' var/agents/health/agent_regenerate_verify.txt >> $GITHUB_STEP_SUMMARY
          fi

  tui-css:
    name: TUI CSS Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Check TUI CSS is up to date
        run: python scripts/ci/check_tui_css_up_to_date.py

  test-guardrails:
    name: Test Guardrails
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Check test hygiene
        run: uv run python scripts/ci/check_test_hygiene.py

      - name: Check legacy patterns
        run: uv run python scripts/ci/check_legacy_patterns.py

      - name: Check legacy triage alignment
        run: uv run python scripts/ci/check_legacy_test_triage.py

      - name: Check dedupe manifest
        run: uv run python scripts/ci/check_dedupe_manifest.py --strict

      - name: Check triage backlog
        run: make test-triage-check

  unit-tests:
    name: Unit Tests (Core)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      GPT_TRADER_STRICT_CONTAINER: "1"
      PYTHONWARNINGS: default
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run unit tests (excluding TUI snapshots)
        run: uv run pytest tests/unit -n auto -q --ignore-glob=tests/unit/gpt_trader/tui/test_snapshots_*.py

  tui-snapshots:
    name: TUI Snapshot Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      GPT_TRADER_STRICT_CONTAINER: "1"
      PYTHONWARNINGS: default
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run TUI snapshot tests
        run: uv run pytest tests/unit/gpt_trader/tui/test_snapshots_*.py -v

  property-tests:
    name: Property Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      GPT_TRADER_STRICT_CONTAINER: "1"
      PYTHONWARNINGS: default
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run property tests
        run: uv run pytest tests/property -v

  contract-tests:
    name: Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      GPT_TRADER_STRICT_CONTAINER: "1"
      PYTHONWARNINGS: default
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run contract tests
        run: uv run pytest tests/contract -v

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Review dependencies
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high

name: Nightly Validation

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write
  issues: write

defaults:
  run:
    shell: bash --noprofile --norc {0}

env:
  PYTHON_VERSION: "3.12"

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - name: Prepare Python environment
        id: setup-uv
        uses: ./.github/actions/setup-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run integration tests
        run: |
          set -euo pipefail
          uv run pytest tests/integration -m integration -v --tb=short

      - name: Report status
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Nightly integration tests failed',
              body: 'The nightly integration tests detected a regression. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.',
              labels: ['bug', 'integration', 'nightly']
            })

  full-test-suite:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6

      - name: Prepare Python environment
        id: setup-uv
        uses: ./.github/actions/setup-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run full test suite (parallel)
        run: |
          set -euo pipefail
          uv run pytest -n auto --dist worksteal -q

      - name: Report status
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Nightly full test suite failed',
              body: 'The nightly full test suite (including slow tests) has failed. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.',
              labels: ['bug', 'tests', 'nightly']
            })

  property-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6

      - name: Prepare Python environment
        uses: ./.github/actions/setup-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run property-based tests
        run: |
          set -euo pipefail
          if [ -d tests/property ]; then
            uv run pytest tests/property/ -v \
              --hypothesis-seed=0 \
              --hypothesis-show-statistics
          else
            echo "No property tests directory found, skipping"
          fi

      - name: Upload hypothesis artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: hypothesis-examples
          path: .hypothesis/
          retention-days: 7
          if-no-files-found: ignore

  performance-benchmarks:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - name: Prepare Python environment
        uses: ./.github/actions/setup-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run benchmarks
        run: |
          set -euo pipefail
          uv run pytest tests/ -m "perf or performance" \
            --benchmark-only \
            --benchmark-json=benchmark-results.json \
            --benchmark-compare-fail=mean:10% || echo "::warning::Performance regression detected or no benchmarks found"

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: benchmark-results
          path: benchmark-results.json
          retention-days: 30
          if-no-files-found: ignore

  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Prepare Python environment
        uses: ./.github/actions/setup-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Security scan with Bandit
        run: |
          set -euo pipefail
          uv run bandit -r src/gpt_trader/ \
            --severity-level medium \
            --confidence-level medium \
            -f json -o bandit-nightly.json

      - name: Dependency audit with pip-audit
        run: |
          set -euo pipefail
          uv run pip-audit -f json -o pip-audit-nightly.json --ignore-vuln GHSA-4xh5-x5gv-qwph || echo "pip-audit completed with warnings"

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: nightly-security-reports
          path: |
            bandit-nightly.json
            pip-audit-nightly.json
          retention-days: 30

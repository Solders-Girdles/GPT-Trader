name: Quality Checks

on:
  workflow_call:
    inputs:
      python-version:
        type: string
        default: "3.12"
      security-severity:
        type: string
        default: "medium"
      upload-reports:
        type: boolean
        default: false

permissions:
  contents: read

defaults:
  run:
    shell: bash --noprofile --norc {0}

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Prepare Python environment
        uses: ./.github/actions/setup-uv
        with:
          python-version: ${{ inputs.python-version }}

      - name: Lint with Ruff
        run: |
          set -euo pipefail
          uv run ruff check .

      - name: Check formatting with Black
        run: |
          set -euo pipefail
          uv run black --check .

      - name: Type-check with MyPy
        id: mypy
        continue-on-error: true
        run: |
          set -euo pipefail
          uv run mypy src/gpt_trader/ 2>&1 | tee mypy-output.txt || true

          # Count errors for summary
          error_count=$(grep -c "^src/gpt_trader" mypy-output.txt || echo "0")
          echo "error_count=$error_count" >> $GITHUB_OUTPUT

          # Fail step if errors found (but continue-on-error allows workflow to proceed)
          if [ "$error_count" -gt 0 ]; then
            echo "::warning::MyPy found $error_count type errors"
            exit 1
          fi

      - name: Add MyPy results to summary
        if: always() && steps.mypy.outcome == 'failure'
        run: |
          echo "### MyPy Type Errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -50 mypy-output.txt >> $GITHUB_STEP_SUMMARY
          if [ $(wc -l < mypy-output.txt) -gt 50 ]; then
            echo "... (truncated, see full output in job logs)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Restore security baseline cache
        id: security-cache
        uses: actions/cache@v4
        with:
          path: .security-baseline
          key: security-baseline-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            security-baseline-

      - name: Security scan with Bandit
        run: |
          set -euo pipefail
          uv run bandit -r src/gpt_trader/ \
            --severity-level ${{ inputs.security-severity }} \
            --confidence-level ${{ inputs.security-severity }} \
            -f json -o bandit-report.json

      - name: Dependency audit with pip-audit
        run: |
          set -euo pipefail
          uv run pip-audit -f json -o pip-audit-report.json --ignore-vuln GHSA-4xh5-x5gv-qwph || echo "pip-audit completed with warnings"

      - name: Compare with security baseline
        if: steps.security-cache.outputs.cache-hit == 'true'
        run: |
          mkdir -p .security-baseline

          # Compare Bandit results
          if [ -f .security-baseline/bandit-baseline.json ] && [ -f bandit-report.json ]; then
            baseline_count=$(jq '.results | length' .security-baseline/bandit-baseline.json 2>/dev/null || echo "0")
            current_count=$(jq '.results | length' bandit-report.json 2>/dev/null || echo "0")

            if [ "$current_count" -gt "$baseline_count" ]; then
              echo "::warning::Security issues increased from $baseline_count to $current_count"
            elif [ "$current_count" -lt "$baseline_count" ]; then
              echo "::notice::Security issues decreased from $baseline_count to $current_count"
            fi
          fi

      - name: Update security baseline
        if: always()
        run: |
          mkdir -p .security-baseline
          [ -f bandit-report.json ] && cp bandit-report.json .security-baseline/bandit-baseline.json
          [ -f pip-audit-report.json ] && cp pip-audit-report.json .security-baseline/pip-audit-baseline.json

      - name: Upload security reports
        if: inputs.upload-reports && always()
        uses: actions/upload-artifact@v5
        with:
          name: security-reports
          path: |
            bandit-report.json
            pip-audit-report.json
          retention-days: 30

name: Python CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: bash --noprofile --norc {0}

env:
  PYTHON_VERSION: "3.12"

jobs:
  core-checks:
    name: Core Checks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Prepare Python environment
      id: setup-poetry
      uses: ./.github/actions/setup-poetry
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Generate dependency artifacts
      if: github.event_name == 'pull_request'
      run: |
        set -euo pipefail
        poetry run python scripts/analysis/dependency_map.py --tests "tests/**/*.py" --output dependency_report.json
        poetry run python scripts/analysis/test_categorizer.py --output test_categories.json

    - name: Run selective tests
      if: github.event_name == 'pull_request'
      env:
        PYTEST_ADDOPTS: '-m "not slow and not performance" -q'
      run: |
        set -euo pipefail
        git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
        CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD -- '*.py' | tr '\n' ' ')
        if [ -z "$CHANGED" ]; then
          poetry run python scripts/testing/selective_runner.py \
            --deps dependency_report.json \
            --categories test_categories.json \
            --max-selective-ratio 0.7 \
            --auto-full-module bot_v2.features.brokerages.core.interfaces
        else
          poetry run python scripts/testing/selective_runner.py \
            --deps dependency_report.json \
            --categories test_categories.json \
            --paths $CHANGED \
            --max-selective-ratio 0.7 \
            --auto-full-module bot_v2.features.brokerages.core.interfaces
        fi

    - name: Lint with ruff
      run: |
        set -euo pipefail
        poetry run ruff check .

    - name: Check formatting with black
      run: |
        set -euo pipefail
        poetry run black --check .

    - name: Type-check with mypy
      run: |
        set -euo pipefail
        poetry run mypy src --ignore-missing-imports

    - name: Run Coinbase core checks
      run: |
        set -euo pipefail
        poetry run pytest tests/unit/bot_v2/features/brokerages/coinbase -q

    - name: Run tests with pytest and generate coverage report
      if: github.event_name != 'pull_request'
      run: |
        set -euo pipefail
        poetry run pytest -m "not slow and not performance" -q \
          --cov=bot_v2 \
          --cov-report=term --cov-report=xml --cov-report=html --cov-fail-under=75

    - name: Upload coverage to Artifacts
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-xml
        path: coverage.xml

    - name: Upload HTML coverage report
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-html
        path: htmlcov

  config-modes:
    name: Config Mode Coverage
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env_mode: ['prod', 'sandbox', 'prod_fallback', 'sandbox_fallback']

    steps:
    - uses: actions/checkout@v5

    - name: Prepare Python environment
      id: setup-poetry
      uses: ./.github/actions/setup-poetry
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Run config tests
      env:
        BROKER: coinbase
        # Production with specific keys
        COINBASE_PROD_API_KEY: ${{ matrix.env_mode == 'prod' && 'prod_key' || '' }}
        COINBASE_PROD_API_SECRET: ${{ matrix.env_mode == 'prod' && 'prod_secret' || '' }}
        # Sandbox with specific keys
        COINBASE_SANDBOX: ${{ (matrix.env_mode == 'sandbox' || matrix.env_mode == 'sandbox_fallback') && '1' || '0' }}
        COINBASE_SANDBOX_API_KEY: ${{ matrix.env_mode == 'sandbox' && 'sandbox_key' || '' }}
        COINBASE_SANDBOX_API_SECRET: ${{ matrix.env_mode == 'sandbox' && 'sandbox_secret' || '' }}
        # Fallback keys
        COINBASE_API_KEY: ${{ (matrix.env_mode == 'prod_fallback' || matrix.env_mode == 'sandbox_fallback') && 'fallback_key' || '' }}
        COINBASE_API_SECRET: ${{ (matrix.env_mode == 'prod_fallback' || matrix.env_mode == 'sandbox_fallback') && 'fallback_secret' || '' }}
      run: |
        set -euo pipefail
        poetry run pytest tests/unit/bot_v2/orchestration/test_config_manager.py tests/unit/bot_v2/orchestration/test_configuration.py

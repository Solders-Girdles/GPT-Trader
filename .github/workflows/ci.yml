name: Python CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      id: setup-python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true

    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root

    - name: Generate dependency artifacts
      if: github.event_name == 'pull_request'
      run: |
        poetry run python scripts/analysis/dependency_map.py --tests "tests/**/*.py" --output dependency_report.json
        poetry run python scripts/analysis/test_categorizer.py --output test_categories.json

    - name: Run selective tests
      if: github.event_name == 'pull_request'
      env:
        PYTEST_ADDOPTS: '-m "not slow and not performance" -q'
      run: |
        git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
        CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD -- '*.py' | tr '\n' ' ')
        if [ -z "$CHANGED" ]; then
          poetry run python scripts/testing/selective_runner.py \
            --deps dependency_report.json \
            --categories test_categories.json \
            --max-selective-ratio 0.7 \
            --auto-full-module bot_v2.features.brokerages.core.interfaces
        else
          poetry run python scripts/testing/selective_runner.py \
            --deps dependency_report.json \
            --categories test_categories.json \
            --paths $CHANGED \
            --max-selective-ratio 0.7 \
            --auto-full-module bot_v2.features.brokerages.core.interfaces
        fi

    - name: Lint with ruff
      run: |
        poetry run ruff check .

    - name: Check formatting with black
      run: |
        poetry run black --check .

    - name: Type-check with mypy
      run: |
        poetry run mypy src --ignore-missing-imports

    - name: Run Coinbase core checks
      run: |
        poetry run pytest tests/unit/bot_v2/features/brokerages/coinbase -q

    - name: Run tests with pytest and generate coverage report
      if: github.event_name != 'pull_request'
      run: |
        poetry run pytest -m "not slow and not performance" -q --cov=src/bot_v2 --cov-report=term-missing --cov-report=xml --cov-report=html --cov-fail-under=60

    - name: Upload coverage to Artifacts
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v3
      with:
        name: coverage-xml
        path: coverage.xml

    - name: Upload HTML coverage report
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v3
      with:
        name: coverage-html
        path: htmlcov

  test-config-matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env_mode: ['prod', 'sandbox', 'prod_fallback', 'sandbox_fallback']
        python-version: ["3.12"]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      id: setup-python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true

    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root

    - name: Run config tests
      env:
        BROKER: coinbase
        # Production with CDP credentials (preferred)
        COINBASE_PROD_CDP_API_KEY: ${{ matrix.env_mode == 'prod' && 'test-cdp-uuid' || '' }}
        COINBASE_PROD_CDP_PRIVATE_KEY: ${{ matrix.env_mode == 'prod' && '-----BEGIN EC PRIVATE KEY-----
MHcCAQEEIEsZvoe/wsksW+W/9GLTBNDA2Kz1ik/6UUJwLaKMImR2oAoGCCqGSM49
AwEHoUQDQgAEthQ2Rkyz9yemEC3sK09H4jeQSanuT98AzIgXTYX0BGQipVYf6QeD
eiu+QIQ1RzW+g4nL9cfoUd2CgZ4sR6S0qA==
-----END EC PRIVATE KEY-----' || '' }}
        # Legacy HMAC fallback for validation checks
        COINBASE_PROD_API_KEY: ${{ matrix.env_mode == 'prod' && 'test-cdp-uuid' || '' }}
        COINBASE_PROD_API_SECRET: ${{ matrix.env_mode == 'prod' && 'placeholder' || '' }}
        # Sandbox with specific keys (Exchange API mode)
        COINBASE_SANDBOX: ${{ (matrix.env_mode == 'sandbox' || matrix.env_mode == 'sandbox_fallback') && '1' || '0' }}
        COINBASE_SANDBOX_API_KEY: ${{ matrix.env_mode == 'sandbox' && 'sandbox_key' || '' }}
        COINBASE_SANDBOX_API_SECRET: ${{ matrix.env_mode == 'sandbox' && 'sandbox_secret' || '' }}
        # Fallback keys
        COINBASE_API_KEY: ${{ (matrix.env_mode == 'prod_fallback' || matrix.env_mode == 'sandbox_fallback') && 'fallback_key' || '' }}
        COINBASE_API_SECRET: ${{ (matrix.env_mode == 'prod_fallback' || matrix.env_mode == 'sandbox_fallback') && 'fallback_secret' || '' }}
      run: |
        poetry run pytest tests/unit/bot_v2/orchestration/test_config_manager.py tests/unit/bot_v2/orchestration/test_configuration.py

  coverage-check:
    name: Coverage (warning @ 70%)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true

    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-3.12-${{ hashFiles('**/poetry.lock') }}

    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root

    - name: Run unit tests with coverage gate (warn only)
      run: |
        poetry run pytest --cov=bot_v2 --cov-report=term-missing --cov-report=html --cov-fail-under=75 \
          tests/unit/bot_v2 tests/unit/test_foundation.py

    - name: Upload coverage report (HTML)
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/

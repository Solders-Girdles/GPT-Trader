name: Targeted Suites

on:
  workflow_dispatch:
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/gpt_trader/features/brokerages/coinbase/**'
      - 'src/gpt_trader/features/live_trade/**'
      - 'tests/unit/gpt_trader/features/brokerages/coinbase/**'
      - 'tests/unit/gpt_trader/features/live_trade/**'
      - 'tests/unit/gpt_trader/orchestration/test_broker_factory.py'
      - 'tests/unit/gpt_trader/orchestration/test_live_execution.py'
      - 'tests/unit/gpt_trader/orchestration/test_execution_coordinator.py'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: bash --noprofile --norc {0}

env:
  PYTHON_VERSION: "3.12"

jobs:
  targeted:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - suite: coinbase-advanced
            category: coinbase-api
            api_mode: advanced
            base_url: https://api.coinbase.com
            needs_passphrase: false
          - suite: coinbase-exchange
            category: coinbase-api
            api_mode: exchange
            base_url: https://api-public.sandbox.exchange.coinbase.com
            needs_passphrase: true
          - suite: coinbase-integration
            category: coinbase-integration
            api_mode: advanced
            base_url: https://api.coinbase.com
            needs_passphrase: false
          - suite: perps
            category: perps

    steps:
      - uses: actions/checkout@v6

      - name: Prepare Python environment
        id: setup-uv
        uses: ./.github/actions/setup-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure Coinbase API mode
        if: startsWith(matrix.suite, 'coinbase')
        uses: ./.github/actions/setup-coinbase-creds
        with:
          mode: api
          api-mode: ${{ matrix.api_mode }}
          api-base: ${{ matrix.base_url }}
          needs-passphrase: ${{ matrix.needs_passphrase }}

      - name: Run Coinbase unit suite
        if: matrix.category == 'coinbase-api'
        run: |
          set -euo pipefail
          uv run pytest tests/unit/gpt_trader/features/brokerages/coinbase -v --maxfail=1 --durations=10
          uv run pytest tests/unit/gpt_trader/orchestration/test_broker_factory.py -v

      - name: Run Coinbase integration smoke
        if: matrix.category == 'coinbase-integration'
        run: |
          set -euo pipefail
          export PYTHONPATH="${GITHUB_WORKSPACE}/src:${GITHUB_WORKSPACE}${PYTHONPATH:+:$PYTHONPATH}"
          uv run pytest tests/unit/gpt_trader/features/brokerages/coinbase/test_adapter_integration.py -v
          uv run python - <<'PY'
          import os
          import sys
          import types

          workspace = os.getcwd()
          src_path = os.path.join(workspace, "src")
          if src_path not in sys.path:
            sys.path.insert(0, src_path)
          if workspace not in sys.path:
            sys.path.insert(0, workspace)

          from src.gpt_trader.features.brokerages.coinbase.ws import CoinbaseWebSocket, SequenceGuard

          mock_ws = types.ModuleType('websocket')
          mock_ws.create_connection = lambda url: None
          sys.modules['websocket'] = mock_ws

          ws = CoinbaseWebSocket('wss://test')
          ws.connect()
          assert ws._transport is not None

          guard = SequenceGuard()
          first = guard.annotate({'sequence': 1})
          assert 'gap_detected' not in first
          second = guard.annotate({'sequence': 3})
          assert second.get('gap_detected') is True
          PY

      - name: Run perps validation suite
        if: matrix.category == 'perps'
        env:
          RUNNER_TEMP: ${{ runner.temp }}
        run: |
          set -euo pipefail
          export PYTHONPATH="${GITHUB_WORKSPACE}/src:${GITHUB_WORKSPACE}${PYTHONPATH:+:$PYTHONPATH}"

          export EVENT_STORE_ROOT="$RUNNER_TEMP/event_store_unit"
          mkdir -p "$EVENT_STORE_ROOT"
          uv run pytest tests/unit/gpt_trader/features/live_trade -q --tb=short

          export EVENT_STORE_ROOT="$RUNNER_TEMP/event_store_orchestration"
          mkdir -p "$EVENT_STORE_ROOT"
          uv run pytest \
            tests/unit/gpt_trader/orchestration/test_live_execution.py \
            tests/unit/gpt_trader/orchestration/test_execution_coordinator.py \
            -q --tb=short

          export EVENT_STORE_ROOT="$RUNNER_TEMP/event_store_validation"
          mkdir -p "$EVENT_STORE_ROOT"
          uv run python scripts/validation/validate_perps_e2e.py

          export EVENT_STORE_ROOT="$RUNNER_TEMP/event_store_paper"
          mkdir -p "$EVENT_STORE_ROOT"
          uv run python scripts/validation/paper_mode_e2e.py

          uv run python -m gpt_trader.cli --help

          export EVENT_STORE_ROOT="$RUNNER_TEMP/event_store_dev"
          export GPT_TRADER_RUNTIME_ROOT="$RUNNER_TEMP/event_store_dev"
          mkdir -p "$EVENT_STORE_ROOT"
          uv run python -m gpt_trader.cli run --profile dev --dry-run --dev-fast --symbols BTC-PERP

          export EVENT_STORE_ROOT="$RUNNER_TEMP/event_store_demo"
          export GPT_TRADER_RUNTIME_ROOT="$RUNNER_TEMP/event_store_demo"
          mkdir -p "$EVENT_STORE_ROOT"
          COINBASE_SANDBOX='1' PERPS_FORCE_MOCK='1' uv run coinbase-trader run --profile demo --dev-fast --reduce-only --symbols BTC-PERP
